From https://github.com/attractivechaos/klib, revision ec8a965711cf44f1e6c2.